# 词云和精华消息功能说明

## 今日词云功能

### 功能描述
- 自动统计群聊消息，生成今日热门词汇
- 0点开始统计，8点后可查看
- 显示TOP 20热门词汇及出现次数

### 使用命令
```
/今日词云
/词云
/热词
```

### 统计规则
- 提取2-4字的中文词组
- 自动过滤停用词（的、了、是等）
- 自动过滤特殊符号和数字
- 显示词频排名和出现次数

### 示例输出
```
📊 今日词云 📊
统计消息: 1234 条
生成时间: 2026-01-15 20:30:15

🔥 热门词汇 TOP 20:
🥇 钓鱼 (156次)
🥈 功德 (142次)
🥉 小喵 (98次)
4. 今天 (87次)
5. 什么 (76次)
...
```

---

## 群精华消息分析功能

### 功能描述
- 获取群精华消息列表
- 自动提取精华消息中的用户ID和内容
- 批量触发人设分析，更新用户标签

### 使用命令
```
/更新精华人设
/精华人设
/分析精华
```

### 工作流程
1. 调用OneBot V11 API获取群精华消息
2. 提取每条精华消息的user_id和文本内容
3. 将精华消息添加到用户的消息历史
4. 触发LLM人设分析，更新用户标签

### 示例输出
```
✅ 已分析 5 位用户的精华消息喵~

张三(3条)
李四(5条)
王五(2条)
赵六(4条)
孙七(1条)
```

### 注意事项
- 需要机器人有获取精华消息的权限
- 部分OneBot实现可能不支持此API
- 精华消息会计入用户的消息历史，影响人设分析

---

## 技术实现

### 词云统计
- 在 `handle_group_watcher()` 中自动调用 `add_message_to_wordcloud()`
- 每条群消息都会被统计（不影响性能）
- 0点自动重置，8点后生成词云

### 精华消息处理
- 使用 `bot.call_api("get_essence_msg_list")` 获取精华消息
- 支持字符串和消息段列表两种格式
- 自动提取昵称（card优先，否则nickname）
- 批量添加消息并触发人设分析

### 插件加载顺序
```python
# bot.py
nonebot.load_plugin("plugins.wordcloud_plugin")  # 词云插件
nonebot.load_plugin("plugins.ai_chat_plugin")    # AI聊天插件（包含精华处理）
```

---

## 更新日志

### 2026-01-15
- ✅ 实现今日词云功能
- ✅ 实现群精华消息获取和人设分析
- ✅ 在群消息监听中添加词云统计
- ✅ 在bot.py中加载wordcloud_plugin
