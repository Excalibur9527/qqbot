# 负功德钓鱼机制说明

## ✅ 当前实现（已验证正确）

### 核心规则
**负功德用户可以钓鱼，但只能钓到暗黑鱼 🖤**

### 实现逻辑

1. **钓鱼不受功德限制**
   - 无论功德是正数、零还是负数，都可以使用 `/钓鱼` 命令
   - 每次钓鱼消耗1点功德（允许功德变为负数）

2. **负功德的特殊效果**
   - 当 `今日功德 < 0` 时，系统会提示："⚠️ 功德为负，只能钓到暗黑鱼..."
   - 鱼类选择被限制为只能从50种暗黑鱼中随机
   - 无法钓到普通鱼、稀有鱼、史诗鱼、闪光鱼

3. **正功德的正常效果**
   - 当 `今日功德 ≥ 0` 时，可以钓到所有类型的鱼
   - 包括：普通鱼、稀有鱼、史诗鱼、暗黑鱼、闪光鱼
   - 功德≥100时，闪光鱼概率提升至15%

### 代码实现位置

**plugins/fishing_service.py**

```python
# 第76行：扣除功德（允许负数）
unified_db.update_merit(group_id, user_id, nickname, -cost)

# 第99-104行：获取今日功德并提示
user = unified_db.get_or_create_user(group_id, user_id, nickname)
today_merit = user.today_merit

# 负功德提示（仍然可以钓鱼，但只能钓暗黑鱼）
if today_merit < 0 and not event_message:
    event_message = "⚠️ 功德为负，只能钓到暗黑鱼..."

# 第149-150行：判断是否只能钓暗黑鱼
# 注意：负功德不会阻止钓鱼，只是限制只能钓到暗黑鱼
dark_only = effects.get("dark_only") or today_merit < 0

# 第158-164行：根据dark_only筛选可钓的鱼
if dark_only:
    available = [f for f in DARK_FISH_LIST if all_time or f.is_active(hour)]
elif no_dark:
    available = [f for f in ALL_FISH if not f.is_dark and (all_time or f.is_active(hour))]
else:
    available = [f for f in ALL_FISH if all_time or f.is_active(hour)]
```

### 测试验证

已通过自动化测试验证：

**测试1：负功德钓鱼**
- 初始功德：-10
- 钓鱼10次
- 结果：10条全部是暗黑鱼 ✅

**测试2：正功德钓鱼**
- 初始功德：+100
- 钓鱼20次
- 结果：18条普通鱼 + 2条暗黑鱼（随机概率）✅

## 📝 与需求文档对照

**需求文档（.kiro/specs/fishing-system/requirements.md）：**
> IF 用户今日功德为负数 THEN THE Fishing_System SHALL 100%只能钓到暗黑鱼

**实现状态：** ✅ 完全符合

## 🎮 玩家体验

### 场景1：功德用完了
- 玩家功德从 5 → 0 → -1 → -2...
- 每次钓鱼都成功，但只能钓到暗黑鱼
- 提示："⚠️ 功德为负，只能钓到暗黑鱼..."

### 场景2：恢复功德
- 玩家使用 `/敲木鱼` 获得功德
- 功德从 -5 → -3 → 0 → +2...
- 一旦功德≥0，立即可以钓到所有类型的鱼

### 场景3：暗黑鱼收集
- 负功德是收集暗黑鱼的"特殊机会"
- 50种暗黑鱼只有在负功德时才100%出现
- 正功德时暗黑鱼概率只有10%

## 🔧 技术细节

### 为什么不阻止负功德钓鱼？

1. **游戏性考虑**
   - 让玩家即使功德为负也能继续游戏
   - 暗黑鱼是独特的收集目标
   - 增加策略性（故意降低功德来收集暗黑鱼）

2. **平衡性考虑**
   - 负功德是一种"惩罚"但不是"禁止"
   - 暗黑鱼也算图鉴进度
   - 玩家可以通过敲木鱼恢复

3. **设计理念**
   - 功德系统是"引导"而非"限制"
   - 所有玩法都应该可访问
   - 负面状态应该有对应的玩法

## 📊 数据统计

### 暗黑鱼列表（50种）
包括但不限于：
- 🖤 诅咒蚌、诅咒鳊、诅咒蝠鲼
- 🕳️ 虚空水母、虚空龙虾、虚空肺鱼
- 🎏 暗黑锦鲤、暗黑龙鱼
- 🐸 堕落蛙
- 🩸 暗影蛭、暗影鲶
- 💀 等等...

### 概率分布
- **负功德时：** 暗黑鱼 100%
- **正功德时：** 
  - 普通鱼 70%
  - 稀有鱼 20%
  - 史诗鱼 8%
  - 传说鱼 2%
  - 暗黑鱼 10%（基础概率）
  - 闪光鱼 5%（功德≥100时15%）

## ✨ 总结

当前实现**完全正确**，符合需求文档和设计意图：
- ✅ 负功德可以钓鱼
- ✅ 负功德只能钓暗黑鱼
- ✅ 正功德可以钓所有鱼
- ✅ 有明确的提示信息
- ✅ 已通过测试验证

如果玩家反馈"被限制钓鱼"，可能是：
1. 混淆了"打窝"的功德要求（打窝需要10功德）
2. 触发了随机事件"暴风雨"（全局禁止钓鱼）
3. 看到暗黑鱼提示误以为是限制
