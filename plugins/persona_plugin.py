"""
ä»Šæ—¥äººè®¾ç”Ÿæˆå™¨æ’ä»¶
æŒ‡ä»¤ï¼šä»Šæ—¥äººè®¾ã€æˆ‘çš„äººè®¾ã€äººè®¾
åŠŸèƒ½ï¼šæ¯å¤©ç»™ç¾¤å‹éšæœºç”Ÿæˆä¸€ä¸ªæç¬‘äººè®¾ï¼ŒåŒä¸€å¤©åŒä¸€äººç»“æœå›ºå®š
æ¯å¤©8ç‚¹åˆ·æ–°
"""

import random
import hashlib
from nonebot import on_command
from nonebot.adapters.onebot.v11 import Bot, Event, Message, MessageSegment, GroupMessageEvent
from nonebot.log import logger

from plugins.daily_utils import get_daily_seed


# äººè®¾è¯åº“
ADJECTIVES = [
    "çº¯æƒ…çš„", "æš´èºçš„", "å¤šé‡‘çš„", "ç†¬å¤œçš„", "ä½›ç³»çš„", "ç¤¾æçš„", "ç¤¾ç‰›çš„",
    "æ‘¸é±¼çš„", "å·ç‹", "èººå¹³çš„", "ç²¾ç¥çš„", "è¿·èŒ«çš„", "å¿«ä¹çš„", "emoçš„",
    "é«˜å†·çš„", "è¯ç—¨çš„", "ç¥ç§˜çš„", "å¯çˆ±çš„", "å¸…æ°”çš„", "ç¾ä¸½çš„", "æ†¨æ†¨çš„",
    "æœºæ™ºçš„", "å‘†èŒçš„", "å‚²å¨‡çš„", "è…¹é»‘çš„", "æ¸©æŸ”çš„", "æš´åŠ›çš„", "æ‡’æ•£çš„",
    "å‹¤å¥‹çš„", "è´ªåƒçš„", "æŒ‘é£Ÿçš„", "å¤±çœ çš„", "å—œç¡çš„", "å¥å¿˜çš„", "è¯å°‘çš„",
    "å…«å¦çš„", "æ¯’èˆŒçš„", "å–„è‰¯çš„", "è…çš„", "ä¸­äºŒçš„", "ç¤¾ç•œ", "å­¦éœ¸",
    "å­¦æ¸£", "è‚å¸", "éé…‹", "æ¬§çš‡", "å’¸é±¼", "å†…å·çš„", "èººèµ¢çš„",
]

JOBS = [
    "äº§å“ç»ç†", "ç¨‹åºå‘˜", "è®¾è®¡å¸ˆ", "è¿è¥", "æµ‹è¯•", "å‰ç«¯", "åç«¯",
    "å…¨æ ˆå·¥ç¨‹å¸ˆ", "æ¶æ„å¸ˆ", "CEO", "CFO", "CTO", "å®ä¹ ç”Ÿ", "è€æ¿",
    "ä¿®è„šå¸ˆå‚…", "å¥¥ç‰¹æ›¼", "å¹²é¥­äºº", "ç¾é£Ÿåšä¸»", "æ¸¸æˆä¸»æ’­", "å¸¦è´§ä¸»æ’­",
    "å¤–å–éª‘æ‰‹", "å¿«é€’å°å“¥", "ç½‘çº¦è½¦å¸æœº", "å¥èº«æ•™ç»ƒ", "ç‘œä¼½è€å¸ˆ",
    "å åœå¸ˆ", "é£æ°´å¤§å¸ˆ", "ç®—å‘½å…ˆç”Ÿ", "å¿ƒç†å’¨è¯¢å¸ˆ", "æƒ…æ„Ÿå¯¼å¸ˆ",
    "äºŒæ¬¡å…ƒå®…", "coser", "ç”»å¸ˆ", "å†™æ‰‹", "upä¸»", "ç½‘çº¢", "æ˜æ˜Ÿç»çºªäºº",
    "èŒä¸šç©å®¶", "ä»£ç»ƒ", "é™ªç©", "é»„ç‰›", "ä¸­ä»‹", "é”€å”®", "å®¢æœ",
    "ä¿å®‰", "ä¿æ´", "å¨å¸ˆ", "è°ƒé…’å¸ˆ", "å’–å•¡å¸ˆ", "ç”œç‚¹å¸ˆ", "èŠ±è‰ºå¸ˆ",
    "å® ç‰©åŒ»ç”Ÿ", "é“²å±å®˜", "çŒ«å¥´", "ç‹—å¥´", "å•èº«ç‹—", "æ‹çˆ±è„‘",
]

STATUSES = [
    "æ­£åœ¨æ‰¾å¯¹è±¡", "åˆšåˆšç ´äº§", "ç»Ÿæ²»ä¸–ç•Œä¸­", "åœ¨æ‘¸é±¼", "åœ¨åˆ’æ°´",
    "åœ¨å†…å·", "åœ¨èººå¹³", "åœ¨emo", "åœ¨å‘å‘†", "åœ¨åšæ¢¦", "åœ¨åŠ ç­",
    "åœ¨é€šå®µ", "åœ¨å…»ç”Ÿ", "åœ¨è¹¦è¿ª", "åœ¨å–å¥¶èŒ¶", "åœ¨åƒç«é”…",
    "åœ¨æ‰“æ¸¸æˆ", "åœ¨è¿½å‰§", "åœ¨åˆ·çŸ­è§†é¢‘", "åœ¨ç½‘ä¸Šå†²æµª", "åœ¨é”®æ”¿",
    "åœ¨ç›¸äº²", "åœ¨åˆ†æ‰‹", "åœ¨å¤åˆ", "åœ¨æš—æ‹", "åœ¨è¡¨ç™½", "åœ¨è¢«æ‹’ç»",
    "åœ¨æš´å¯Œä¸­", "åœ¨è¿˜èŠ±å‘—", "åœ¨åƒåœŸ", "åœ¨ç†è´¢", "åœ¨ç‚’è‚¡",
    "åœ¨å¥èº«", "åœ¨å‡è‚¥", "åœ¨æš´é¥®æš´é£Ÿ", "åœ¨æˆ’ç³–", "åœ¨å–é…’",
    "åœ¨å­¦ä¹ ", "åœ¨æ‘†çƒ‚", "åœ¨ç„¦è™‘", "åœ¨å¿«ä¹", "åœ¨å‘ç–¯", "åœ¨å†·é™",
    "åœ¨è£…æ­»", "åœ¨ç¤¾æ­»", "åœ¨å°´å°¬", "åœ¨å®³ç¾", "åœ¨ç”Ÿæ°”", "åœ¨å“­æ³£",
    "åœ¨å·å·è§‚å¯Ÿä½ ", "åœ¨ç­‰ä¸‹ç­", "åœ¨ç­‰å‘å·¥èµ„", "åœ¨ç­‰å‘¨æœ«",
]

# ç‰¹æ®Šç»„åˆï¼ˆä½æ¦‚ç‡è§¦å‘ï¼‰
SPECIAL_PERSONAS = [
    "æ¥è‡ª2077å¹´çš„èµ›åšæœ‹å…‹ï¼Œæ­£åœ¨ä¿®å¤æ—¶é—´çº¿bug",
    "è¢«é€‰ä¸­çš„å‹‡è€…ï¼Œä½†åªæƒ³å›å®¶ç§ç”°",
    "éšè—çš„å¯ŒäºŒä»£ï¼Œæ­£åœ¨ä½“éªŒç”Ÿæ´»",
    "ç©¿è¶Šæ¥çš„å¤äººï¼Œå¯¹æ‰‹æœºå¾ˆæ„Ÿå…´è¶£",
    "é€€ä¼‘çš„è¶…çº§è‹±é›„ï¼Œç°åœ¨åªæƒ³å®‰é™å–èŒ¶",
    "è§‰é†’äº†çš„NPCï¼Œå‘ç°è‡ªå·±åœ¨æ¸¸æˆé‡Œ",
    "å¹³è¡Œä¸–ç•Œçš„ä½ ï¼Œé‚£è¾¹çš„ä½ æ˜¯ä¸ªå¤§æ˜æ˜Ÿ",
    "è¢«è¯…å’’çš„ç‹å­/å…¬ä¸»ï¼Œåªæœ‰çœŸçˆ±ä¹‹å»èƒ½è§£é™¤",
    "å…¶å®æ˜¯AIï¼Œæ­£åœ¨å­¦ä¹ å¦‚ä½•åšäºº",
    "å¤–æ˜Ÿäººå§åº•ï¼Œåœ°çƒè§‚å¯Ÿæ—¥è®°ç¬¬114514å¤©",
]


def get_daily_persona(user_id: str, group_id: str) -> str:
    """
    æ ¹æ®ç”¨æˆ·IDã€ç¾¤IDç”Ÿæˆå›ºå®šçš„ä»Šæ—¥äººè®¾
    æ¯å¤©8ç‚¹åˆ·æ–°ï¼ŒåŒä¸€å¤©åŒä¸€äººåœ¨åŒä¸€ç¾¤ç»“æœç›¸åŒ
    """
    seed_str = get_daily_seed(user_id, group_id)
    seed = int(hashlib.md5(seed_str.encode()).hexdigest(), 16)
    
    rng = random.Random(seed)
    
    # 1% æ¦‚ç‡è§¦å‘ç‰¹æ®Šäººè®¾
    if rng.random() < 0.01:
        return rng.choice(SPECIAL_PERSONAS)
    
    adj = rng.choice(ADJECTIVES)
    job = rng.choice(JOBS)
    status = rng.choice(STATUSES)
    
    return f"{adj}{job}ï¼Œç›®å‰{status}"


# æ³¨å†Œå‘½ä»¤
persona_cmd = on_command("ä»Šæ—¥äººè®¾", aliases={"æˆ‘çš„äººè®¾", "äººè®¾", "ä»Šæ—¥èº«ä»½"}, priority=5, block=True)


@persona_cmd.handle()
async def handle_persona(bot: Bot, event: Event):
    """ç”Ÿæˆä»Šæ—¥äººè®¾"""
    try:
        if not isinstance(event, GroupMessageEvent):
            await persona_cmd.finish("è¯·åœ¨ç¾¤é‡ŒæŸ¥çœ‹äººè®¾å–µ~")
            return
        
        user_id = event.get_user_id()
        group_id = str(event.group_id)
        
        sender = event.sender
        nickname = sender.card if sender.card else sender.nickname
        if not nickname:
            nickname = user_id
        
        persona = get_daily_persona(user_id, group_id)
        
        result = f"ğŸ­ {nickname} çš„ä»Šæ—¥äººè®¾ï¼š\n\nã€Œ{persona}ã€"
        
        await persona_cmd.finish(Message([
            MessageSegment.at(user_id),
            MessageSegment.text(f"\n{result}")
        ]))
        
    except Exception as e:
        if "FinishedException" in str(type(e)):
            return
        logger.error(f"ä»Šæ—¥äººè®¾å¼‚å¸¸: {e}")
