"""
ä»Šæ—¥å¡”ç½—ç‰Œæ’ä»¶
æŒ‡ä»¤ï¼šä»Šæ—¥å¡”ç½—ã€å¡”ç½—ç‰Œã€å åœã€æŠ½å¡”ç½—
åŠŸèƒ½ï¼šæ¯å¤©ç»™ç¾¤å‹æŠ½ä¸€å¼ å¡”ç½—ç‰Œï¼ŒåŒä¸€å¤©åŒä¸€äººç»“æœå›ºå®š
æ¯å¤©8ç‚¹åˆ·æ–°ï¼Œé™„å¸¦éšæœºé­”æ³•çŒªå›¾ç‰‡
"""

import random
import hashlib
from pathlib import Path
from typing import Optional
from nonebot import on_command
from nonebot.adapters.onebot.v11 import Bot, Event, Message, MessageSegment, GroupMessageEvent
from nonebot.log import logger

from plugins.daily_utils import get_daily_seed


# å›¾ç‰‡ç›®å½•
PLUGIN_DIR = Path(__file__).parent
MAGIC_PIG_DIR = PLUGIN_DIR / "magic_pig"

# å¤§é˜¿å°”å¡çº³ (Major Arcana) - 22å¼ 
MAJOR_ARCANA = [
    "æ„šè€…", "é­”æœ¯å¸ˆ", "å¥³æ•™çš‡", "çš‡å", "çš‡å¸", "æ•™çš‡", "æ‹äºº", "æˆ˜è½¦",
    "åŠ›é‡", "éšå£«", "å‘½è¿ä¹‹è½®", "æ­£ä¹‰", "å€’åŠäºº", "æ­»ç¥", "èŠ‚åˆ¶", "æ¶é­”",
    "é«˜å¡”", "æ˜Ÿæ˜Ÿ", "æœˆäº®", "å¤ªé˜³", "å®¡åˆ¤", "ä¸–ç•Œ"
]

# å°é˜¿å°”å¡çº³èŠ±è‰²
SUITS = ["æƒæ–", "åœ£æ¯", "å®å‰‘", "æ˜Ÿå¸"]
RANKS = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "ä¾ä»", "éª‘å£«", "ç‹å", "å›½ç‹"]

# ç‰Œæ„åº“ - å¤§é˜¿å°”å¡çº³ 22å¼  + å°é˜¿å°”å¡çº³ 56å¼ 
MEANINGS = {
    # ========== å¤§é˜¿å°”å¡çº³ (22å¼ ) ==========
    "æ„šè€…": "æ–°çš„å¼€å§‹ã€å†’é™©ã€çº¯çœŸã€è‡ªå‘æ€§ã€‚ä»£è¡¨ç€æ— é™å¯èƒ½ä¸å‹‡æ•¢è¸å‡ºç¬¬ä¸€æ­¥ã€‚",
    "é­”æœ¯å¸ˆ": "åˆ›é€ åŠ›ã€æ„å¿—åŠ›ã€è¡ŒåŠ¨åŠ›ã€æ½œåŠ›ã€‚ä½ æ‹¥æœ‰å®ç°ç›®æ ‡çš„ä¸€åˆ‡èµ„æºã€‚",
    "å¥³æ•™çš‡": "ç›´è§‰ã€ç¥ç§˜ã€æ½œæ„è¯†ã€å†·é™è§‚å¯Ÿã€‚ç›¸ä¿¡ä½ å†…å¿ƒçš„å£°éŸ³ã€‚",
    "çš‡å": "ä¸°é¥¶ã€æ¯æ€§ã€åˆ›é€ ã€è‡ªç„¶ã€‚äº«å—ç”Ÿæ´»çš„ç¾å¥½ä¸å¯Œè¶³ã€‚",
    "çš‡å¸": "æƒå¨ã€ç»“æ„ã€æ§åˆ¶ã€çˆ¶æ€§ã€‚å»ºç«‹ç§©åºï¼ŒæŒæ§å±€é¢ã€‚",
    "æ•™çš‡": "ä¼ ç»Ÿã€ä¿¡ä»°ã€æ•™å¯¼ã€ç²¾ç¥æŒ‡å¼•ã€‚å¯»æ±‚æ™ºæ…§ä¸æŒ‡å¯¼ã€‚",
    "æ‹äºº": "çˆ±æƒ…ã€å’Œè°ã€é€‰æ‹©ã€ä»·å€¼è§‚çš„å¥‘åˆã€‚é¢ä¸´é‡è¦çš„äººç”ŸæŠ‰æ‹©ã€‚",
    "æˆ˜è½¦": "èƒœåˆ©ã€æ„å¿—ã€å†³å¿ƒã€è¡ŒåŠ¨ã€‚å‹‡å¾€ç›´å‰ï¼Œå…‹æœéšœç¢ã€‚",
    "åŠ›é‡": "å‹‡æ°”ã€è€å¿ƒã€å†…åœ¨åŠ›é‡ã€æ¸©æŸ”ã€‚ä»¥æŸ”å…‹åˆšï¼Œå†…å¿ƒå¼ºå¤§ã€‚",
    "éšå£«": "å†…çœã€ç‹¬å¤„ã€å¯»æ±‚çœŸç†ã€æ™ºæ…§ã€‚å‘å†…æ¢ç´¢ï¼Œå¯»æ‰¾ç­”æ¡ˆã€‚",
    "å‘½è¿ä¹‹è½®": "å‘½è¿ã€è½¬æŠ˜ã€æœºé‡ã€å¾ªç¯ã€‚ç”Ÿå‘½çš„èµ·ä¼æ˜¯è‡ªç„¶è§„å¾‹ã€‚",
    "æ­£ä¹‰": "å…¬æ­£ã€çœŸç›¸ã€å› æœã€å¹³è¡¡ã€‚è¯šå®é¢å¯¹ï¼Œæ‰¿æ‹…è´£ä»»ã€‚",
    "å€’åŠäºº": "ç‰ºç‰²ã€ç­‰å¾…ã€æ–°è§†è§’ã€æ”¾ä¸‹ã€‚æ¢ä¸ªè§’åº¦çœ‹é—®é¢˜ã€‚",
    "æ­»ç¥": "ç»“æŸã€è½¬å˜ã€é‡ç”Ÿã€å‘Šåˆ«è¿‡å»ã€‚æ—§çš„ç»“æŸæ˜¯æ–°çš„å¼€å§‹ã€‚",
    "èŠ‚åˆ¶": "å¹³è¡¡ã€è€å¿ƒã€è°ƒå’Œã€ä¸­åº¸ã€‚ä¿æŒé€‚åº¦ï¼Œå’Œè°å…±å¤„ã€‚",
    "æ¶é­”": "æŸç¼šã€è¯±æƒ‘ã€ç‰©è´¨ã€é˜´æš—é¢ã€‚è­¦æƒ•å†…å¿ƒçš„æ¬²æœ›ä¸æ‰§å¿µã€‚",
    "é«˜å¡”": "å‰§å˜ã€ç¾éš¾ã€çœŸç›¸å¤§ç™½ã€æ‰“ç ´æ—§ä¹ ã€‚çªå¦‚å…¶æ¥çš„æ”¹å˜å¸¦æ¥è§‰é†’ã€‚",
    "æ˜Ÿæ˜Ÿ": "å¸Œæœ›ã€çµæ„Ÿã€å®é™ã€ä¿¡å¿ƒã€‚é»‘æš—è¿‡åå¿…æœ‰å…‰æ˜ã€‚",
    "æœˆäº®": "å¹»è§‰ã€ææƒ§ã€æ½œæ„è¯†ã€ä¸ç¡®å®šã€‚é¢å¯¹å†…å¿ƒçš„è¿·èŒ«ä¸ä¸å®‰ã€‚",
    "å¤ªé˜³": "æˆåŠŸã€å¿«ä¹ã€æ´»åŠ›ã€è‡ªä¿¡ã€‚å…‰æ˜æ­£å¤§ï¼Œå……æ»¡èƒ½é‡ã€‚",
    "å®¡åˆ¤": "è§‰é†’ã€é‡ç”Ÿã€åæ€ã€å¬å”¤ã€‚å€¾å¬å†…å¿ƒçš„å‘¼å”¤ï¼Œåšå‡ºæ”¹å˜ã€‚",
    "ä¸–ç•Œ": "è¾¾æˆã€åœ†æ»¡ã€æ—…è¡Œã€ä¸€ä¸ªé˜¶æ®µçš„ç»ˆç»“ã€‚å®Œæˆä½¿å‘½ï¼Œè¿æ¥æ–°ç¯‡ç« ã€‚",
    
    # ========== æƒæ–ç‰Œç»„ (ç«å…ƒç´  - è¡ŒåŠ¨ã€çƒ­æƒ…ã€åˆ›é€ ) ==========
    "æƒæ–1": "æ–°çš„å¼€å§‹ã€çµæ„Ÿã€æ½œåŠ›ã€åˆ›é€ åŠ›çš„ç§å­ã€‚ä¸€ä¸ªå……æ»¡å¯èƒ½æ€§çš„æœºä¼šæ­£åœ¨èŒèŠ½ã€‚",
    "æƒæ–2": "è®¡åˆ’ã€å†³ç­–ã€å±•æœ›æœªæ¥ã€‚ç«™åœ¨åå­—è·¯å£ï¼Œéœ€è¦åšå‡ºé€‰æ‹©ã€‚",
    "æƒæ–3": "æ‰©å±•ã€è¿œè§ã€é¢†å¯¼åŠ›ã€‚ä½ çš„åŠªåŠ›å¼€å§‹æ˜¾ç°æˆæœï¼Œå‰æ–¹ä¸€ç‰‡å…‰æ˜ã€‚",
    "æƒæ–4": "åº†ç¥ã€å’Œè°ã€å®¶åº­å¹¸ç¦ã€‚æ”¶è·çš„å–œæ‚¦ï¼Œç¨³å®šçš„åŸºç¡€å·²ç»å»ºç«‹ã€‚",
    "æƒæ–5": "ç«äº‰ã€å†²çªã€æŒ‘æˆ˜ã€‚æ„è§åˆ†æ­§éœ€è¦è§£å†³ï¼Œä½†ä¹Ÿèƒ½æ¿€å‘æˆé•¿ã€‚",
    "æƒæ–6": "èƒœåˆ©ã€è®¤å¯ã€æˆå°±ã€‚ä½ çš„åŠªåŠ›å¾—åˆ°äº†å›æŠ¥å’Œèµèµã€‚",
    "æƒæ–7": "åšæŒã€é˜²å¾¡ã€å‹‡æ°”ã€‚é¢å¯¹æŒ‘æˆ˜è¦åšå®ˆç«‹åœºï¼Œä¸è¦è½»æ˜“æ”¾å¼ƒã€‚",
    "æƒæ–8": "å¿«é€Ÿè¡ŒåŠ¨ã€è¿›å±•ã€æ¶ˆæ¯ã€‚äº‹æƒ…æ­£åœ¨è¿…é€Ÿå‘å±•ï¼Œä¿æŒä¸“æ³¨ã€‚",
    "æƒæ–9": "åšéŸ§ã€æ¯…åŠ›ã€æœ€åçš„è€ƒéªŒã€‚è™½ç„¶ç–²æƒ«ï¼Œä½†èƒœåˆ©å°±åœ¨çœ¼å‰ã€‚",
    "æƒæ–10": "è´Ÿæ‹…ã€è´£ä»»ã€å‹åŠ›ã€‚æ‰¿æ‹…äº†å¤ªå¤šï¼Œéœ€è¦å­¦ä¼šåˆ†æ‹…æˆ–æ”¾ä¸‹ã€‚",
    "æƒæ–ä¾ä»": "çƒ­æƒ…ã€æ¢ç´¢ã€æ–°æ¶ˆæ¯ã€‚å……æ»¡å¥½å¥‡å¿ƒï¼Œå‹‡äºå°è¯•æ–°äº‹ç‰©ã€‚",
    "æƒæ–éª‘å£«": "å†’é™©ã€å†²åŠ¨ã€è¡ŒåŠ¨åŠ›ã€‚å……æ»¡æ¿€æƒ…åœ°è¿½æ±‚ç›®æ ‡ï¼Œä½†è¦æ³¨æ„æ–¹å‘ã€‚",
    "æƒæ–ç‹å": "è‡ªä¿¡ã€ç‹¬ç«‹ã€æ¸©æš–ã€‚ä»¥çƒ­æƒ…å’Œé­…åŠ›å½±å“å‘¨å›´çš„äººã€‚",
    "æƒæ–å›½ç‹": "é¢†å¯¼åŠ›ã€è¿œè§ã€ä¼ä¸šå®¶ç²¾ç¥ã€‚æœ‰èƒ½åŠ›å°†æ„¿æ™¯å˜ä¸ºç°å®ã€‚",
    
    # ========== åœ£æ¯ç‰Œç»„ (æ°´å…ƒç´  - æƒ…æ„Ÿã€ç›´è§‰ã€å…³ç³») ==========
    "åœ£æ¯1": "æ–°çš„æ„Ÿæƒ…ã€ç›´è§‰ã€æƒ…æ„Ÿçš„å¼€å§‹ã€‚å¿ƒçµæ·±å¤„æ¶Œç°æ–°çš„æ„Ÿå—ã€‚",
    "åœ£æ¯2": "ä¼™ä¼´å…³ç³»ã€å¸å¼•ã€è”ç»“ã€‚ä¸¤é¢—å¿ƒçš„ç›¸é‡ï¼Œå’Œè°çš„å…³ç³»ã€‚",
    "åœ£æ¯3": "åº†ç¥ã€å‹è°Šã€ç¤¾äº¤ã€‚ä¸æœ‹å‹åˆ†äº«å¿«ä¹ï¼Œäº«å—ç¾å¥½æ—¶å…‰ã€‚",
    "åœ£æ¯4": "å†·æ¼ ã€ä¸æ»¡ã€é”™è¿‡æœºä¼šã€‚æ²‰æµ¸åœ¨è‡ªå·±çš„ä¸–ç•Œï¼Œå¿½ç•¥äº†çœ¼å‰çš„ç¾å¥½ã€‚",
    "åœ£æ¯5": "å¤±è½ã€æ‚²ä¼¤ã€é—æ†¾ã€‚ç»å†æƒ…æ„Ÿä¸Šçš„æŸå¤±ï¼Œä½†ä»æœ‰å¸Œæœ›å­˜åœ¨ã€‚",
    "åœ£æ¯6": "æ€€æ—§ã€ç«¥å¹´å›å¿†ã€çº¯çœŸã€‚è¿‡å»çš„ç¾å¥½è®°å¿†å¸¦æ¥æ¸©æš–ã€‚",
    "åœ£æ¯7": "å¹»æƒ³ã€é€‰æ‹©ã€ç™½æ—¥æ¢¦ã€‚é¢å¯¹ä¼—å¤šé€‰æ‹©ï¼Œéœ€è¦åˆ†æ¸…ç°å®ä¸å¹»æƒ³ã€‚",
    "åœ£æ¯8": "ç¦»å¼€ã€æ”¾å¼ƒã€å¯»æ‰¾æ›´æ·±çš„æ„ä¹‰ã€‚æ˜¯æ—¶å€™å‘Šåˆ«ï¼Œè¿½å¯»å†…å¿ƒçœŸæ­£çš„æ¸´æœ›ã€‚",
    "åœ£æ¯9": "æ»¡è¶³ã€æ„¿æœ›æˆçœŸã€å¹¸ç¦ã€‚æƒ…æ„Ÿä¸Šçš„æ»¡è¶³ï¼Œæ¢¦æƒ³å®ç°ã€‚",
    "åœ£æ¯10": "å®¶åº­å¹¸ç¦ã€æƒ…æ„Ÿåœ†æ»¡ã€å’Œè°ã€‚çˆ±ä¸å¹¸ç¦ç¯ç»•ï¼Œå®Œç¾çš„æƒ…æ„ŸçŠ¶æ€ã€‚",
    "åœ£æ¯ä¾ä»": "æ•æ„Ÿã€ç›´è§‰ã€åˆ›æ„ã€‚å¸¦ç€å¥½å¥‡å¿ƒæ¢ç´¢æƒ…æ„Ÿä¸–ç•Œã€‚",
    "åœ£æ¯éª‘å£«": "æµªæ¼«ã€é­…åŠ›ã€è¿½æ±‚ã€‚ä¸ºçˆ±æƒ…æˆ–ç†æƒ³è€Œè¡ŒåŠ¨çš„éª‘å£«ã€‚",
    "åœ£æ¯ç‹å": "åŒç†å¿ƒã€ç›´è§‰ã€æƒ…æ„Ÿæ™ºæ…§ã€‚æ·±åˆ»ç†è§£ä»–äººï¼Œç»™äºˆå…³æ€€ã€‚",
    "åœ£æ¯å›½ç‹": "æƒ…æ„Ÿæˆç†Ÿã€å¹³è¡¡ã€æ™ºæ…§ã€‚ä»¥å†·é™å’Œç†è§£å¤„ç†æƒ…æ„Ÿé—®é¢˜ã€‚",
    
    # ========== å®å‰‘ç‰Œç»„ (é£å…ƒç´  - æ€ç»´ã€æ²Ÿé€šã€çœŸç›¸) ==========
    "å®å‰‘1": "æ¸…æ™°ã€çœŸç›¸ã€çªç ´ã€‚æ€ç»´çš„åŠ›é‡ï¼Œåˆ‡å¼€è¿·é›¾è§çœŸç›¸ã€‚",
    "å®å‰‘2": "åƒµå±€ã€å¹³è¡¡ã€å›é¿ã€‚æš‚æ—¶çš„åœæ»ï¼Œéœ€è¦åšå‡ºå†³å®šã€‚",
    "å®å‰‘3": "å¿ƒç¢ã€æ‚²ä¼¤ã€ç—›è‹¦ã€‚æƒ…æ„Ÿä¸Šçš„ä¼¤å®³ï¼Œä½†è¿™æ˜¯æ„ˆåˆçš„å¼€å§‹ã€‚",
    "å®å‰‘4": "ä¼‘æ¯ã€æ¢å¤ã€æ²‰æ€ã€‚æš‚æ—¶é€€å‡ºï¼Œç»™è‡ªå·±ç–—æ„ˆçš„æ—¶é—´ã€‚",
    "å®å‰‘5": "å†²çªã€å¤±è´¥ã€è‡ªç§ã€‚äº‰æ–—å¸¦æ¥çš„æŸå¤±ï¼Œéœ€è¦åæ€ã€‚",
    "å®å‰‘6": "è¿‡æ¸¡ã€æ”¹å˜ã€ç¦»å¼€å›°å¢ƒã€‚ç¦»å¼€å›°éš¾ï¼Œé©¶å‘å¹³é™çš„æ°´åŸŸã€‚",
    "å®å‰‘7": "æ¬ºéª—ã€ç­–ç•¥ã€éšè—ã€‚éœ€è¦è°¨æ…è¡Œäº‹ï¼Œæ³¨æ„éšè—çš„é—®é¢˜ã€‚",
    "å®å‰‘8": "é™åˆ¶ã€å›°å¢ƒã€å—å®³è€…å¿ƒæ€ã€‚æ„Ÿè§‰è¢«å›°ä½ï¼Œä½†å‡ºè·¯å°±åœ¨çœ¼å‰ã€‚",
    "å®å‰‘9": "ç„¦è™‘ã€å™©æ¢¦ã€æ‹…å¿§ã€‚å†…å¿ƒçš„ææƒ§æ¯”ç°å®æ›´å¯æ€•ã€‚",
    "å®å‰‘10": "ç»“æŸã€ç—›è‹¦çš„ç»ˆç»“ã€æ–°ç”Ÿã€‚æœ€é»‘æš—çš„æ—¶åˆ»å·²è¿‡ï¼Œé»æ˜å°†è‡³ã€‚",
    "å®å‰‘ä¾ä»": "å¥½å¥‡ã€è­¦è§‰ã€æ–°æƒ³æ³•ã€‚ä»¥æ•é”çš„å¤´è„‘è§‚å¯Ÿä¸–ç•Œã€‚",
    "å®å‰‘éª‘å£«": "æœæ–­ã€ç›´æ¥ã€é‡å¿ƒã€‚å¿«é€Ÿè¡ŒåŠ¨ï¼Œä½†è¦æ³¨æ„ä¸è¦ä¼¤å®³ä»–äººã€‚",
    "å®å‰‘ç‹å": "ç‹¬ç«‹ã€æ¸…æ™°ã€ç›´è¨€ä¸è®³ã€‚ä»¥ç†æ€§å’Œæ™ºæ…§åšå‡ºåˆ¤æ–­ã€‚",
    "å®å‰‘å›½ç‹": "æƒå¨ã€çœŸç›¸ã€æ™ºæ…§ã€‚ä»¥å…¬æ­£å’Œç†æ€§é¢†å¯¼ï¼Œè¿½æ±‚çœŸç†ã€‚",
    
    # ========== æ˜Ÿå¸ç‰Œç»„ (åœŸå…ƒç´  - ç‰©è´¨ã€è´¢å¯Œã€å®é™…) ==========
    "æ˜Ÿå¸1": "æ–°çš„æœºä¼šã€ç¹è£ã€ç‰©è´¨çš„å¼€å§‹ã€‚è´¢å¯Œæˆ–äº‹ä¸šçš„æ–°èµ·ç‚¹ã€‚",
    "æ˜Ÿå¸2": "å¹³è¡¡ã€é€‚åº”ã€çµæ´»ã€‚åœ¨å¤šä¸ªäº‹åŠ¡é—´ä¿æŒå¹³è¡¡ã€‚",
    "æ˜Ÿå¸3": "å›¢é˜Ÿåˆä½œã€æŠ€èƒ½ã€å­¦ä¹ ã€‚é€šè¿‡åˆä½œå’Œå­¦ä¹ è·å¾—æˆé•¿ã€‚",
    "æ˜Ÿå¸4": "å®‰å…¨ã€ä¿å®ˆã€æ§åˆ¶ã€‚ä¿æŠ¤å·²æœ‰çš„ï¼Œä½†è¦æ³¨æ„ä¸è¦è¿‡äºåå•¬ã€‚",
    "æ˜Ÿå¸5": "å›°éš¾ã€è´«å›°ã€å­¤ç«‹ã€‚ç‰©è´¨ä¸Šçš„å›°å¢ƒï¼Œä½†å¸®åŠ©å°±åœ¨èº«è¾¹ã€‚",
    "æ˜Ÿå¸6": "æ…·æ…¨ã€åˆ†äº«ã€å…¬å¹³äº¤æ¢ã€‚ç»™äºˆå’Œæ¥å—çš„å¹³è¡¡ã€‚",
    "æ˜Ÿå¸7": "è€å¿ƒã€æŠ•èµ„ã€é•¿æœŸè§„åˆ’ã€‚æ’­ä¸‹çš„ç§å­éœ€è¦æ—¶é—´æˆé•¿ã€‚",
    "æ˜Ÿå¸8": "å‹¤å¥‹ã€æŠ€è‰ºã€ä¸“æ³¨ã€‚é€šè¿‡åŠªåŠ›å·¥ä½œç£¨ç»ƒæŠ€èƒ½ã€‚",
    "æ˜Ÿå¸9": "ç‹¬ç«‹ã€ä¸°ç››ã€è‡ªç»™è‡ªè¶³ã€‚äº«å—åŠªåŠ›å¸¦æ¥çš„æˆæœã€‚",
    "æ˜Ÿå¸10": "è´¢å¯Œã€ä¼ æ‰¿ã€å®¶æ—ã€‚ç‰©è´¨ä¸Šçš„åœ†æ»¡ï¼Œç•™ç»™åä»£çš„é—äº§ã€‚",
    "æ˜Ÿå¸ä¾ä»": "å­¦ä¹ ã€æ–°æŠ€èƒ½ã€æœºä¼šã€‚è„šè¸å®åœ°åœ°è¿½æ±‚ç›®æ ‡ã€‚",
    "æ˜Ÿå¸éª‘å£«": "å‹¤åŠ³ã€å¯é ã€ç¨³å®šã€‚ç¨³æ­¥å‰è¿›ï¼Œæ³¨é‡å®é™…ã€‚",
    "æ˜Ÿå¸ç‹å": "å®é™…ã€æ…·æ…¨ã€å®‰å…¨æ„Ÿã€‚åˆ›é€ èˆ’é€‚çš„ç¯å¢ƒï¼Œç…§é¡¾ä»–äººã€‚",
    "æ˜Ÿå¸å›½ç‹": "æˆåŠŸã€è´¢å¯Œã€ç¨³å®šã€‚ç‰©è´¨ä¸Šçš„æˆå°±ï¼Œå¯é çš„é¢†å¯¼è€…ã€‚",
}

# é€†ä½è§£è¯»å‰ç¼€
REVERSED_PREFIX = [
    "ï¼ˆé€†ä½ï¼‰éœ€è¦åå‘æ€è€ƒï¼š",
    "ï¼ˆé€†ä½ï¼‰è­¦ç¤ºä½ æ³¨æ„ï¼š",
    "ï¼ˆé€†ä½ï¼‰æé†’ä½ åæ€ï¼š",
]


def find_magic_pig_images() -> list:
    """æŸ¥æ‰¾æ‰€æœ‰é­”æ³•çŒªå›¾ç‰‡"""
    if not MAGIC_PIG_DIR.exists():
        return []
    exts = ["png", "jpg", "jpeg", "webp", "gif"]
    images = []
    for ext in exts:
        images.extend(MAGIC_PIG_DIR.glob(f"*.{ext}"))
    return images


def get_daily_tarot(user_id: str, group_id: str) -> dict:
    """
    æ ¹æ®ç”¨æˆ·IDå’Œç¾¤IDç”Ÿæˆå›ºå®šçš„ä»Šæ—¥å¡”ç½—ç‰Œ
    æ¯å¤©8ç‚¹åˆ·æ–°
    è¿”å›: {card_name, orientation, meaning, is_major, image_path}
    """
    seed_str = get_daily_seed(user_id, group_id)
    seed = int(hashlib.md5(seed_str.encode()).hexdigest(), 16)
    rng = random.Random(seed)
    
    # 40% æ¦‚ç‡æŠ½åˆ°å¤§é˜¿å°”å¡çº³ï¼ˆå¢åŠ çç¨€æ„Ÿï¼‰
    if rng.random() < 0.4:
        card_name = rng.choice(MAJOR_ARCANA)
        is_major = True
    else:
        suit = rng.choice(SUITS)
        rank = rng.choice(RANKS)
        card_name = f"{suit}{rank}"
        is_major = False
    
    # 50% æ¦‚ç‡æ­£ä½/é€†ä½
    is_upright = rng.random() > 0.5
    orientation = "æ­£ä½" if is_upright else "é€†ä½"
    
    # è·å–ç‰Œæ„
    base_meaning = MEANINGS.get(card_name, "å‘½è¿çš„æŒ‡å¼•æ­£å¤„äºè¿·é›¾ä¸­ï¼Œè¯·ç”¨å¿ƒæ„Ÿæ‚Ÿã€‚")
    if is_upright:
        meaning = base_meaning
    else:
        prefix = rng.choice(REVERSED_PREFIX)
        meaning = prefix + base_meaning
    
    # éšæœºé€‰æ‹©ä¸€å¼ é­”æ³•çŒªå›¾ç‰‡
    images = find_magic_pig_images()
    image_path = rng.choice(images) if images else None
    
    return {
        "card_name": card_name,
        "orientation": orientation,
        "meaning": meaning,
        "is_major": is_major,
        "image_path": image_path
    }


# æ³¨å†Œå‘½ä»¤
tarot_cmd = on_command("ä»Šæ—¥å¡”ç½—", aliases={"å¡”ç½—ç‰Œ", "å åœ", "æŠ½å¡”ç½—", "å¡”ç½—"}, priority=5, block=True)


@tarot_cmd.handle()
async def handle_tarot(bot: Bot, event: Event):
    """æŠ½ä»Šæ—¥å¡”ç½—ç‰Œ"""
    try:
        if not isinstance(event, GroupMessageEvent):
            await tarot_cmd.finish("è¯·åœ¨ç¾¤é‡Œå åœå–µ~")
            return
        
        user_id = event.get_user_id()
        group_id = str(event.group_id)
        
        sender = event.sender
        nickname = sender.card if sender.card else sender.nickname
        if not nickname:
            nickname = user_id
        
        # è·å–ä»Šæ—¥å¡”ç½—
        result = get_daily_tarot(user_id, group_id)
        
        card_name = result["card_name"]
        orientation = result["orientation"]
        meaning = result["meaning"]
        is_major = result["is_major"]
        image_path = result["image_path"]
        
        # å¤§é˜¿å°”å¡çº³æ ‡è®°
        arcana_mark = "ã€å¤§é˜¿å°”å¡çº³ã€‘" if is_major else ""
        
        # æ„å»ºæ¶ˆæ¯
        msg = Message()
        
        # æ·»åŠ å›¾ç‰‡
        if image_path and image_path.exists():
            try:
                img_bytes = image_path.read_bytes()
                msg.append(MessageSegment.image(img_bytes))
            except Exception as e:
                logger.error(f"è¯»å–å¡”ç½—å›¾ç‰‡å¤±è´¥: {e}")
        
        # æ„å»ºæ–‡æ¡ˆ
        text_lines = [
            f"\nâœ¨ --- å åœä¹‹é•œ --- âœ¨",
            f"ğŸ‘¤ å åœè€…ï¼š{nickname}",
            f"--------------------",
            f"ğŸ”® æŠ½å–ç‰Œé¢ï¼šã€{card_name}ã€‘{arcana_mark}",
            f"ğŸ’¡ å½“å‰çŠ¶æ€ï¼š{orientation}",
            f"ğŸ“ ç‰Œæ„è§£æï¼š{meaning}",
            f"--------------------",
            f"ğŸŒŸ å¡”ç½—ä»…ä¾›å‚è€ƒï¼Œå‘½è¿æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­å–µ~"
        ]
        
        msg.append(MessageSegment.at(user_id))
        msg.append(MessageSegment.text("\n".join(text_lines)))
        
        await tarot_cmd.finish(msg)
        
        logger.info(f"å¡”ç½—å åœ: {nickname} æŠ½åˆ° {card_name} {orientation}")
        
    except Exception as e:
        if "FinishedException" in str(type(e)):
            return
        logger.error(f"å¡”ç½—å åœå¼‚å¸¸: {e}")
